<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI & Agents</title>
    <style>
      :root { color-scheme: light dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, sans-serif; }
      header { padding: 12px 16px; border-bottom: 1px solid #4443; display: flex; gap: 12px; align-items: center; }
      h1 { font-size: 16px; margin: 0; font-weight: 600; }
      .status { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      .badge { font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid #8884; display: inline-flex; align-items: center; gap: 6px; }
      .ok { background: #16a34a22; color: #16a34a; border-color: #16a34a55; }
      .warn { background: #f59e0b22; color: #f59e0b; border-color: #f59e0b55; }
      .err { background: #ef444422; color: #ef4444; border-color: #ef444455; }
      main { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; }
      section { border: 1px solid #8883; border-radius: 8px; overflow: hidden; }
      section > header { border: 0; background: #8881; }
      .panel { padding: 12px 16px; }
      label { display: block; font-size: 12px; opacity: .8; }
      textarea, input[type="text"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #8885; background: transparent; color: inherit; }
      button { padding: 6px 10px; border-radius: 6px; border: 1px solid #8885; background: transparent; color: inherit; cursor: pointer; }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .row { display: flex; gap: 8px; align-items: center; }
      .col { display: grid; gap: 8px; }
      .error { color: #ef4444; font-size: 13px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    </style>
  </head>
  <body>
    <header>
      <h1>AI & Agents</h1>
      <div id="status" class="status"></div>
      <button id="refresh">Refresh</button>
    </header>
    <main>
      <section>
        <header><h2 class="mono">Status</h2></header>
        <div class="panel">
          <div id="statusDetails" class="col"></div>
        </div>
      </section>
      <section>
        <header><h2 class="mono">Chat</h2></header>
        <div class="panel col">
          <label for="chatInput">Prompt</label>
          <textarea id="chatInput" rows="4" placeholder="Ask something…"></textarea>
          <div class="row">
            <button id="chatSend">Send</button>
          </div>
          <div><label>Response</label><pre id="chatOut"></pre></div>
          <div id="chatErr" class="error" style="display:none"></div>
        </div>
      </section>
      <section>
        <header><h2 class="mono">Workflows</h2></header>
        <div class="panel col">
          <div class="row">
            <button data-flow="code-rag">Run Code‑RAG</button>
            <input id="codeRagQuery" type="text" placeholder="Query (e.g., how vms API works)" />
          </div>
          <div class="row">
            <button data-flow="media-fixups">Run Media Fix‑ups</button>
            <input id="mediaFile" type="text" placeholder="/mnt/appdata/addons/documents_processed/sample.pdf" />
          </div>
          <div class="row">
            <button data-flow="sysadmin-ops">Run Sysadmin Ops</button>
            <input id="sysTask" type="text" placeholder="Describe the task…" />
          </div>
          <div><label>Result</label><pre id="flowOut"></pre></div>
          <div id="flowErr" class="error" style="display:none"></div>
        </div>
      </section>
      <section>
        <header><h2 class="mono">Simulations</h2></header>
        <div class="panel col">
          <label>Payload JSON</label>
          <textarea id="simJson" rows="6">{"example": true}</textarea>
          <label>Instructions</label>
          <input id="simInstr" type="text" value="Analyze and summarize insights." />
          <div class="row">
            <button id="simRun">Analyze</button>
          </div>
          <div><label>Output</label><pre id="simOut"></pre></div>
          <div id="simErr" class="error" style="display:none"></div>
        </div>
      </section>
      <section>
        <header><h2 class="mono">MCP Servers</h2></header>
        <div class="panel col">
          <div id="mcpList" class="col"></div>
          <div id="mcpErr" class="error" style="display:none"></div>
        </div>
      </section>
      <section>
        <header><h2 class="mono">Agents Roster</h2></header>
        <div class="panel col">
          <div class="row">
            <label class="mono">Server</label>
            <select id="rosterServer"></select>
            <button id="loadTools">Load Tools</button>
            <input id="toolFilter" type="text" placeholder="Filter tools…" />
          </div>
          <div class="row">
            <label class="mono">Tool</label>
            <select id="rosterTool"></select>
          </div>
          <label>Arguments (JSON)</label>
          <textarea id="toolArgs" rows="4">{}</textarea>
          <div class="row">
            <button id="callTool">Call Tool</button>
          </div>
          <div><label>Result</label><pre id="toolOut"></pre></div>
          <div id="toolErr" class="error" style="display:none"></div>
        </div>
      </section>
    </main>

    <script>
      async function api(path, opts) {
        const url = new URL(path, window.location.origin);
        const res = await fetch(url, {
          method: opts?.method || 'GET',
          headers: { 'content-type': 'application/json' },
          body: opts?.body ? JSON.stringify(opts.body) : undefined,
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      function badge(label, ok) {
        const cls = ok === 'healthy' ? 'ok' : (ok === 'degraded' || ok === 'unknown') ? 'warn' : 'err';
        return `<span class="badge ${cls}">${label}: ${ok}</span>`;
      }

      function renderStatus(data) {
        const sEl = document.getElementById('status');
        sEl.innerHTML = badge('Overall', data.status) +
          badge('Worker', data.worker.status) +
          badge('Router', data.router.status) +
          badge('AI Stack', data.ai_stack.status);

        const dEl = document.getElementById('statusDetails');
        let mcp = data.router.mcp_servers || {};
        const mcpList = Object.keys(mcp).map(k => `${k}: ${mcp[k] ? 'healthy' : 'unhealthy'}`).join('\n');
        dEl.innerHTML = `
          <div class="col">
            <div><strong>Worker</strong>: ${JSON.stringify(data.worker)}</div>
            <div><strong>Router</strong>: <pre>${JSON.stringify(data.router, null, 2)}</pre></div>
            <div><strong>AI Stack</strong>: <pre>${JSON.stringify(data.ai_stack, null, 2)}</pre></div>
            <div><strong>MCP Servers</strong>: <pre>${mcpList}</pre></div>
          </div>`;
      }

      async function loadStatus() {
        try {
          const data = await api('/api/ai/status');
          renderStatus(data);
        } catch (e) {
          document.getElementById('status').innerHTML = badge('Overall', 'unreachable');
        }
      }

      // Chat
      document.getElementById('chatSend').addEventListener('click', async () => {
        const input = document.getElementById('chatInput').value.trim();
        const out = document.getElementById('chatOut');
        const err = document.getElementById('chatErr');
        out.textContent = '';
        err.style.display = 'none';
        try {
          const resp = await api('/api/ai/query', { method: 'POST', body: { prompt: input }});
          out.textContent = JSON.stringify(resp, null, 2);
        } catch (e) {
          err.style.display = '';
          err.textContent = e.message || String(e);
        }
      });

      // Workflows
      document.querySelectorAll('button[data-flow]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const flow = btn.getAttribute('data-flow');
          const out = document.getElementById('flowOut');
          const err = document.getElementById('flowErr');
          out.textContent=''; err.style.display='none';
          try {
            const input = flow === 'code-rag' ? { query: document.getElementById('codeRagQuery').value } :
                          flow === 'media-fixups' ? { file: document.getElementById('mediaFile').value, instruction: 'Analyze document and propose fixes.' } :
                          { task: document.getElementById('sysTask').value };
            const resp = await api('/api/ai/workflows/run', { method: 'POST', body: { name: flow, input } });
            out.textContent = JSON.stringify(resp, null, 2);
          } catch (e) {
            err.style.display = '';
            err.textContent = e.message || String(e);
          }
        });
      });

      // Simulations
      document.getElementById('simRun').addEventListener('click', async () => {
        const out = document.getElementById('simOut');
        const err = document.getElementById('simErr');
        out.textContent=''; err.style.display='none';
        try {
          const payload = JSON.parse(document.getElementById('simJson').value || '{}');
          const instructions = document.getElementById('simInstr').value;
          const resp = await api('/api/ai/simulations/analyze', { method: 'POST', body: { payload, instructions } });
          out.textContent = JSON.stringify(resp, null, 2);
        } catch (e) {
          err.style.display = '';
          err.textContent = e.message || String(e);
        }
      });

      document.getElementById('refresh').addEventListener('click', loadStatus);
      loadStatus();
      setInterval(loadStatus, 10000);

      // MCP Servers
      async function loadMCP() {
        const listEl = document.getElementById('mcpList');
        const err = document.getElementById('mcpErr');
        err.style.display = 'none';
        listEl.innerHTML = 'Loading…';
        try {
          const data = await api('/api/ai/mcp/servers');
          const servers = data.servers || [];
          listEl.innerHTML = servers.map(s => {
            const checked = s.enabled ? 'checked' : '';
            return `<div class="row" data-name="${s.name}">
              <input type="checkbox" class="mcpToggle" ${checked} />
              <span class="mono">${s.name}</span>
              <span class="badge ${s.type ? 'ok' : 'warn'}">${s.type || 'unknown'}</span>
              <span class="mono" style="opacity:.8">${s.url}</span>
            </div>`;
          }).join('');

          // Populate roster server dropdown
          const select = document.getElementById('rosterServer');
          select.innerHTML = servers.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

          listEl.querySelectorAll('.mcpToggle').forEach(cb => {
            cb.addEventListener('change', async (e) => {
              const row = e.target.closest('[data-name]');
              const name = row.getAttribute('data-name');
              try {
                await api(`/api/ai/mcp/servers/${name}/enable`, { method: 'POST', body: { enabled: e.target.checked } });
              } catch (err2) {
                alert('Failed to toggle: ' + (err2.message || err2));
                e.target.checked = !e.target.checked;
              }
            });
          });
        } catch (e) {
          listEl.innerHTML = '';
          err.style.display = '';
          err.textContent = e.message || String(e);
        }
      }

      // Agents Roster
      document.getElementById('loadTools').addEventListener('click', async () => {
        const server = document.getElementById('rosterServer').value;
        const toolSel = document.getElementById('rosterTool');
        const filter = (document.getElementById('toolFilter').value || '').toLowerCase();
        const err = document.getElementById('toolErr');
        toolSel.innerHTML=''; err.style.display='none';
        try {
          const data = await api(`/api/ai/mcp/servers/${server}/tools`);
          const tools = (data.tools || []).filter(t => !filter || (t.name || '').toLowerCase().includes(filter));
          toolSel.innerHTML = tools.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
        } catch (e) {
          err.style.display = '';
          err.textContent = e.message || String(e);
        }
      });

      document.getElementById('callTool').addEventListener('click', async () => {
        const server = document.getElementById('rosterServer').value;
        const tool = document.getElementById('rosterTool').value;
        const argsText = document.getElementById('toolArgs').value || '{}';
        const out = document.getElementById('toolOut');
        const err = document.getElementById('toolErr');
        out.textContent=''; err.style.display='none';
        try {
          const argumentsObj = JSON.parse(argsText);
          const resp = await api('/api/ai/mcp/call', { method: 'POST', body: { server, tool, arguments: argumentsObj } });
          out.textContent = JSON.stringify(resp, null, 2);
        } catch (e) {
          err.style.display = '';
          err.textContent = e.message || String(e);
        }
      });

      // initial loads
      loadMCP();
    </script>
  </body>
  </html>
