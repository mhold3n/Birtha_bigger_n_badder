<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Control · VMs</title>
    <style>
      :root { color-scheme: light dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, sans-serif; }
      header { padding: 12px 16px; border-bottom: 1px solid #4443; display: flex; align-items: center; gap: 12px; }
      h1 { font-size: 16px; margin: 0; font-weight: 600; }
      .toolbar { margin-left: auto; display: flex; gap: 8px; align-items: center; }
      .pill { font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px solid #8884; }
      main { padding: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #8882; font-size: 14px; }
      th { background: #8881; position: sticky; top: 0; backdrop-filter: blur(4px); }
      .status { font-weight: 600; text-transform: uppercase; font-size: 11px; padding: 2px 6px; border-radius: 6px; display: inline-block; }
      .running { background: #16a34a22; color: #16a34a; border: 1px solid #16a34a55; }
      .stopped { background: #ef444422; color: #ef4444; border: 1px solid #ef444455; }
      .degraded { background: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b55; }
      button { padding: 6px 10px; border-radius: 6px; border: 1px solid #8885; background: transparent; color: inherit; cursor: pointer; }
      button[disabled] { opacity: 0.5; cursor: not-allowed; }
      .row-actions { display: flex; gap: 8px; }
      .muted { opacity: 0.8; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .error { color: #ef4444; font-size: 13px; }
    </style>
  </head>
  <body>
    <header>
      <h1>System Control · VMs</h1>
      <div class="toolbar">
        <span id="summary" class="pill">Loading…</span>
        <button id="refresh">Refresh</button>
      </div>
    </header>
    <main>
      <div id="error" class="error" style="display:none"></div>
      <table>
        <thead>
          <tr>
            <th>VMID</th>
            <th>Name</th>
            <th>Node</th>
            <th>Type</th>
            <th>Status</th>
            <th>CPU</th>
            <th>RAM</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </main>
    <script>
      const rowsEl = document.getElementById('rows');
      const summaryEl = document.getElementById('summary');
      const errorEl = document.getElementById('error');

      async function api(path, opts) {
        const url = new URL(path, window.location.origin);
        const res = await fetch(url, {
          method: opts?.method || 'GET',
          headers: { 'content-type': 'application/json' },
          body: opts?.body ? JSON.stringify(opts.body) : undefined,
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      function fmtBytes(bytes) {
        if (!bytes) return '—';
        const gb = bytes / (1024 ** 3);
        return `${gb.toFixed(1)} GB`;
      }

      function statusBadge(status) {
        const cls = status === 'running' || status === 'online' ? 'running' : (status === 'stopped' || status === 'offline' ? 'stopped' : 'degraded');
        return `<span class="status ${cls}">${status || 'unknown'}</span>`;
      }

      function render(items) {
        rowsEl.innerHTML = items.map(it => {
          const vmid = it.id;
          const canStart = it.status !== 'running';
          const canStop = it.status === 'running';
          return `<tr>
            <td class="mono">${vmid}</td>
            <td>${it.name || ''}</td>
            <td class="mono muted">${it.node || ''}</td>
            <td class="mono muted">${it.type || ''}</td>
            <td>${statusBadge(it.status)}</td>
            <td class="mono">${it.cpu ?? '—'}</td>
            <td class="mono">${fmtBytes(it.mem)}</td>
            <td>
              <div class="row-actions">
                <button data-action="start" data-id="${vmid}" ${canStart ? '' : 'disabled'}>Start</button>
                <button data-action="stop" data-id="${vmid}" ${canStop ? '' : 'disabled'}>Stop</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        rowsEl.querySelectorAll('button[data-action]').forEach(btn => {
          btn.addEventListener('click', async () => {
            btn.disabled = true;
            try {
              const id = btn.getAttribute('data-id');
              const action = btn.getAttribute('data-action');
              await api(`/api/vms/${id}/${action}`, { method: 'POST' });
              await load(true);
            } catch (e) {
              errorEl.style.display = '';
              errorEl.textContent = `Action failed: ${e.message || e}`;
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      async function load(silent=false) {
        if (!silent) { summaryEl.textContent = 'Loading…'; }
        errorEl.style.display = 'none';
        try {
          const { items } = await api('/api/vms');
          render(items);
          const running = items.filter(i => i.status === 'running').length;
          summaryEl.textContent = `${running}/${items.length} running`;
        } catch (e) {
          summaryEl.textContent = 'Error';
          errorEl.style.display = '';
          try {
            const d = JSON.parse(e.message);
            errorEl.textContent = d.detail || e.message || String(e);
          } catch { errorEl.textContent = String(e); }
        }
      }

      document.getElementById('refresh').addEventListener('click', () => load());
      load();
      setInterval(() => load(true), 10000);
    </script>
  </body>
  </html>

